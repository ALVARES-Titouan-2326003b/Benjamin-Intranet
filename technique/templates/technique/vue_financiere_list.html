{% extends "base.html" %}
{% load static %}

{% block title %}Vue financière – Pôle technique{% endblock %}

{% block content %}
<div class="d-flex justify-between align-center mb-4"
    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div>
        <h2>Vue financière – Pôle technique</h2>
        <p style="color: var(--text-secondary); margin-top: 0.5rem;">
            Suivi des budgets, frais engagés et paiements projet par projet.
        </p>
    </div>
    <button class="btn btn-primary" id="showCreateFormBtn">
        <i class="bi bi-plus-lg"></i> Créer un projet
    </button>
</div>

<!-- Formulaire Création (Hidden by default) -->
<div class="card mb-4" id="createProjectForm" style="display: none; margin-bottom: 1.5rem;">
    <div class="card-title">Créer un nouveau projet</div>
    <form method="post">
        {% csrf_token %}
        <div
            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
            {{ form.as_p }}
        </div>
        <div style="display: flex; justify-content: flex-end;">
            <button type="submit" class="btn btn-primary">Créer le projet</button>
        </div>
    </form>
</div>

<!-- Liste des projets -->
<div class="card">
    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
        <span>Projets techniques</span>
        <span class="badge" style="background: var(--bg-secondary); color: var(--text-secondary);">
            {{ projects|length }} projet{% if projects|length > 1 %}s{% endif %}
        </span>
    </div>

    {% if projects %}

<!-- Bouton suppression projets -->
<form method="post" action="{% url 'technique_bulk_delete_projects' %}" id="bulkDeleteProjectsForm" style="margin-bottom: 1rem;">
    {% csrf_token %}
    <button type="submit" class="btn btn-danger" id="deleteProjectsBtn" style="display: none;" 
            onclick="return confirm('⚠️ Êtes-vous sûr de vouloir supprimer les projets sélectionnés ? Cette action est irréversible.');">
        <i class="bi bi-trash"></i> Supprimer la sélection (<span id="selectedProjectsCount">0</span>)
    </button>

    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th style="width: 40px;"><input type="checkbox" id="selectAllProjects" title="Tout sélectionner"></th>
                    <th>Référence</th>
                    <th>Nom</th>
                    <th>Total estimé</th>
                    <th class="text-right">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for p in projects %}
                <tr>
                    <td><input type="checkbox" class="project-checkbox" name="project_ids" value="{{ p.id }}"></td>
                    <td>
                        <span style="font-weight: 600; color: var(--text-main);">{{ p.reference }}</span>
                    </td>
                    <td>{{ p.name }}</td>
                    <td>
                        <span class="badge" style="background: #e0f2fe; color: #0284c7;">{{ p.total_estimated }}
                            €</span>
                    </td>
                    <td class="text-right">
                        <a href="{% url 'technique_financial_project_detail' p.pk %}" class="btn btn-sm btn-ghost">
                            Voir / éditer
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
</form>
    </div>
    {% else %}
    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
        <i class="bi bi-folder-x" style="font-size: 2rem; display: block; margin-bottom: 1rem;"></i>
        Aucun projet technique pour le moment.
    </div>
    {% endif %}
</div>

<script>
// Gestion de la sélection multiple pour les projets
document.addEventListener('DOMContentLoaded', function() {
    const selectAllProjects = document.getElementById('selectAllProjects');
    const deleteProjectsBtn = document.getElementById('deleteProjectsBtn');
    const selectedProjectsCount = document.getElementById('selectedProjectsCount');
    
    if (selectAllProjects) {
        selectAllProjects.addEventListener('change', function() {
            document.querySelectorAll('.project-checkbox').forEach(cb => cb.checked = this.checked);
            updateProjectsButton();
        });
        
        document.querySelectorAll('.project-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateProjectsButton);
        });
    }
    
    function updateProjectsButton() {
        const count = document.querySelectorAll('.project-checkbox:checked').length;
        deleteProjectsBtn.style.display = count > 0 ? 'inline-block' : 'none';
        selectedProjectsCount.textContent = count;
        if (selectAllProjects) {
            const total = document.querySelectorAll('.project-checkbox').length;
            selectAllProjects.checked = total > 0 && count === total;
        }
    }
});
</script>

<script>
    document.getElementById("showCreateFormBtn").addEventListener("click", function () {
        const form = document.getElementById("createProjectForm");
        form.style.display = (form.style.display === "none") ? "block" : "none";
    });
</script>

<style>
    /* Quick fix for form.as_p rendering */
    #createProjectForm p {
        margin-bottom: 0;
    }

    #createProjectForm input,
    #createProjectForm select,
    #createProjectForm textarea {
        display: block;
        width: 100%;
        padding: 0.5rem;
        font-size: 0.95rem;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        margin-top: 0.25rem;
    }

    #createProjectForm label {
        font-weight: 500;
        font-size: 0.9rem;
        color: var(--text-main);
    }
</style>
{% endblock %}