{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-between align-center mb-4"
  style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
  <h2>Documents techniques</h2>
  <a class="btn btn-primary" href="{% url 'technique:documents_upload' %}">
    <i class="bi bi-upload"></i> Importer un document
  </a>
</div>

<div class="card">
  <form method="get"
    style="display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center; background: #f8fafc; padding: 1rem; border-radius: var(--radius-md); border: 1px solid var(--border-light);">
    <div style="flex: 1;">
      <input type="text" name="projet" class="form-control" placeholder="Rechercher par projet..." value="{{ projet }}"
        style="margin: 0;">
    </div>
    <button type="submit" class="btn btn-secondary">
      <i class="bi bi-filter"></i> Filtrer
    </button>
    {% if projet %}
    <a href="{% url 'technique:documents_list' %}" class="btn btn-ghost"
      style="text-decoration: none; color: var(--text-secondary);">
      <i class="bi bi-x-circle"></i> Réinitialiser
    </a>
    {% endif %}
  </form>

  
<!-- Bouton suppression documents -->
<form method="post" action="{% url 'technique:bulk_delete_documents' %}" id="bulkDeleteDocsForm" style="margin-bottom: 1rem;">
    {% csrf_token %}
    <button type="submit" class="btn btn-danger" id="deleteDocsBtn" style="display: none;" 
            onclick="return confirm('⚠️ Êtes-vous sûr de vouloir supprimer les documents sélectionnés ? Cette action est irréversible.');">
        <i class="bi bi-trash"></i> Supprimer la sélection (<span id="selectedDocsCount">0</span>)
    </button>

<div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th style="width: 40px;"><input type="checkbox" id="selectAllDocs" title="Tout sélectionner"></th>
          <th>Projet</th>
          <th>Titre</th>
          <th>Type</th>
          <th>Créé le</th>
          <th class="text-right">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for doc in documents %}
        <tr>
          <td><input type="checkbox" class="doc-checkbox" name="document_ids" value="{{ doc.id }}"></td>
          <td>
            <span style="font-weight: 500; color: var(--text-main);">{{ doc.projet|default:"—" }}</span>
          </td>
          <td>
            <a href="{% url 'technique:documents_detail' doc.pk %}"
              style="color: var(--accent); text-decoration: none; font-weight: 500;">
              {{ doc.titre }}
            </a>
          </td>
          <td>
            <span class="badge" style="background: #e0f2fe; color: #0284c7;">{{ doc.get_type_document_display }}</span>
          </td>
          <td style="color: var(--text-secondary);">{{ doc.created_at|date:"d/m/Y H:i" }}</td>
          <td class="text-right">
            <a href="{% url 'technique:documents_detail' doc.pk %}" class="btn btn-sm btn-ghost"
              title="Voir les détails">
              <i class="bi bi-eye"></i>
            </a>

            {# Bouton de téléchargement du résumé PDF #}
            {% if doc.resume %}
            <a href="{% url 'technique:document_resume_pdf' doc.pk %}" class="btn btn-sm btn-ghost text-danger"
              title="Télécharger le résumé PDF">
              <i class="bi bi-file-pdf"></i>
            </a>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-muted" style="padding: 2rem;">Aucun document trouvé.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
</form>
  </div>
</div>

<script>
// Gestion de la sélection multiple pour les documents
document.addEventListener('DOMContentLoaded', function() {
    const selectAllDocs = document.getElementById('selectAllDocs');
    const deleteDocsBtn = document.getElementById('deleteDocsBtn');
    const selectedDocsCount = document.getElementById('selectedDocsCount');
    
    if (selectAllDocs) {
        selectAllDocs.addEventListener('change', function() {
            document.querySelectorAll('.doc-checkbox').forEach(cb => cb.checked = this.checked);
            updateDocsButton();
        });
        
        document.querySelectorAll('.doc-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateDocsButton);
        });
    }
    
    function updateDocsButton() {
        const count = document.querySelectorAll('.doc-checkbox:checked').length;
        deleteDocsBtn.style.display = count > 0 ? 'inline-block' : 'none';
        selectedDocsCount.textContent = count;
        if (selectAllDocs) {
            const total = document.querySelectorAll('.doc-checkbox').length;
            selectAllDocs.checked = total > 0 && count === total;
        }
    }
});
</script>

{% endblock %}