{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="d-flex justify-between align-center mb-4"
    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h2>Factures</h2>
    <div style="display: flex; gap: 0.5rem;">
        {% if access_finance%}
        <a class="btn btn-secondary" href="{% url 'invoices:dashboard' %}">
            <i class="bi bi-bar-chart-fill"></i> Tableau de bord
        </a>
        <a class="btn btn-primary" href="{% url 'invoices:create' %}">
            <i class="bi bi-plus-lg"></i> Nouvelle facture
        </a>
        {% endif %}
    </div>
</div>

<!-- Filters Card -->
<!-- Bouton Relance Manuelle avec champ délai -->
    {% if access_finance%}
    <div style="margin-bottom: 1.5rem;">
        <form method="post" action="{% url 'invoices:manual_reminders' %}"
              style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
            {% csrf_token %}

            <!-- Champ délai relance -->
            <div class="form-group" style="margin: 0; flex: 0 0 200px;">
                <label class="form-label" style="font-size: 0.9rem; margin-bottom: 0.5rem;">
                    Délai relance (jours)
                </label>
                <input type="number"
                       name="delai_relance"
                       value="1"
                       min="1"
                       class="form-control"
                       style="font-weight: 600;"
                       required>
            </div>

            <!-- Bouton relance -->
            <button type="submit"
                    class="btn btn-warning"
                    style="font-weight: 600; padding: 0.75rem 1.5rem; flex: 1; min-width: 200px;"
                    onclick="return confirm('Cette action va lancer la relance manuelle.\n\nVoulez-vous continuer ?');">
                Lancer la relance manuelle
            </button>
        </form>

        <small style="display: block; margin-top: 0.5rem; color: var(--text-secondary); font-style: italic;">
            Le délai sera appliqué à tous les fournisseurs
        </small>
    </div>
    {% endif %}
<div class="card">
    <div class="card-title">
        <span><i class="bi bi-funnel"></i> Filtres</span>
        <a href="{% url 'invoices:list' %}" class="btn btn-sm btn-secondary"
            style="font-size: 0.8rem; padding: 0.25rem 0.75rem;">
            Réinitialiser
        </a>
    </div>

    <form method="get"
        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; align-items: end;">
        <div class="form-group" style="margin: 0;">
            <label class="form-label" style="font-size: 0.8rem;">Fournisseur</label>
            <input type="text" name="fournisseur" value="{{ request.GET.fournisseur }}" class="form-control"
                placeholder="Rech...">
        </div>

        <div class="form-group" style="margin: 0;">
            <label class="form-label" style="font-size: 0.8rem;">Client</label>
            <input type="text" name="client" value="{{ request.GET.client }}" class="form-control"
                placeholder="Rech...">
        </div>

        <div class="form-group" style="margin: 0;">
            <label class="form-label" style="font-size: 0.8rem;">Montant (Min)</label>
            <input type="number" step="0.01" name="min_amount" value="{{ request.GET.min_amount }}" class="form-control"
                placeholder="0.00">
        </div>

        <div class="form-group" style="margin: 0;">
            <label class="form-label" style="font-size: 0.8rem;">Montant (Max)</label>
            <input type="number" step="0.01" name="max_amount" value="{{ request.GET.max_amount }}" class="form-control"
                placeholder="0.00">
        </div>

        <div class="form-group" style="margin: 0;">
            <label class="form-label" style="font-size: 0.8rem;">Statut</label>
            <select name="statut" class="form-control">
                <option value="">Tous</option>
                <option value="Reçue" {% if request.GET.statut == 'Reçue' %}selected{% endif %}>Reçue</option>
                <option value="En cours" {% if request.GET.statut == 'En cours' %}selected{% endif %}>En cours</option>
                <option value="Payée" {% if request.GET.statut == 'Payée' %}selected{% endif %}>Payée</option>
                <option value="Refusée" {% if request.GET.statut == 'Refusée' %}selected{% endif %}>Refusée</option>
                <option value="Archivée" {% if request.GET.statut == 'Archivée' %}selected{% endif %}>Archivée</option>
            </select>
        </div>

        <div class="form-group" style="margin: 0;">
            <label class="form-label" style="font-size: 0.8rem;">Pôle</label>
            <input type="text" name="pole" value="{{ request.GET.pole }}" class="form-control" placeholder="Service...">
        </div>

        <div class="form-group" style="margin: 0; grid-column: span 2;">
            <label class="form-label" style="font-size: 0.8rem;">Échéance (Période)</label>
            <div style="display: flex; gap: 0.5rem;">
                <input type="date" name="echeance_min" value="{{ request.GET.echeance_min }}" class="form-control">
                <input type="date" name="echeance_max" value="{{ request.GET.echeance_max }}" class="form-control">
            </div>
        </div>

        <div class="form-group" style="margin: 0;">
            <button type="submit" class="btn btn-secondary" style="width: 100%;">
                <i class="bi bi-search"></i> Filtrer
            </button>
        </div>
    </form>
</div>

<!-- Invoices Table -->
<div class="card" style="padding: 0; overflow: hidden;">
    <div class="table-responsive">
        <table class="table">
            <thead style="background: #f8fafc;">
                <tr>
                    <th style="padding-left: 1.5rem;">ID</th>
                    <th>Fournisseur</th>
                    <th>Client</th>
                    <th>Montant</th>
                    <th>Statut</th>
                    <th>Échéance</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for invoice in object_list %}
                <tr>
                    <td style="padding-left: 1.5rem;">
                        <a href="{% url 'invoices:detail' invoice.pk %}"
                            style="font-weight: 600; color: var(--accent);">
                            #{{ invoice.id }}
                        </a>
                    </td>
                    <td>{{ invoice.fournisseur|default:"—" }}</td>
                    <td>
                        <div style="display: flex; flex-direction: column;">
                            <span style="font-weight: 500;">{{ invoice.client.nom|default:"—" }}</span>
                            {% if invoice.client_id and invoice.client_id != invoice.client.nom %}
                            <span style="font-size: 0.75rem; color: var(--text-secondary);">{{ invoice.client_id
                                }}</span>
                            {% endif %}
                        </div>
                    </td>
                    <td style="font-family: monospace; font-size: 0.95rem;">
                        {% if invoice.montant %}
                        {{ invoice.montant }} €
                        {% else %}
                        <span style="color: #ccc;">—</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if invoice.statut %}
                        {% with s=invoice.statut %}
                        {% if 'Payée' in s %}<span class="badge badge-success">Payée</span>
                        {% elif 'En cours' in s %}<span class="badge badge-info text-dark">En cours</span>
                        {% elif 'Retard' in s or 'Refusée' in s %}<span class="badge badge-danger">{{ s }}</span>
                        {% else %}<span class="badge" style="background: #e2e8f0; color: #475569;">{{ s }}</span>
                        {% endif %}
                        {% endwith %}
                        {% else %}
                        —
                        {% endif %}
                    </td>
                    <td>
                        {% if invoice.echeance %}
                        {{ invoice.echeance|date:"d M Y" }}
                        {% else %}
                        —
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'invoices:detail' invoice.pk %}" class="btn btn-sm btn-secondary"
                            style="padding: 0.2rem 0.6rem; font-size: 0.8rem;">
                            Voir
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-secondary);">Aucune
                        facture
                        trouvée.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if page_obj.has_previous or page_obj.has_next %}
<div class="d-flex justify-center"
    style="display: flex; justify-content: flex-end; align-items: center; gap: 1rem; margin-top: 1rem;">
    {% if page_obj.has_previous %}
    <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}"
        class="btn btn-secondary">
        Précédent
    </a>
    {% endif %}

    <span style="font-size: 0.9rem; color: var(--text-secondary);">Page {{ page_obj.number }} / {{
        page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
    <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.next_page_number }}"
        class="btn btn-secondary">
        Suivant
    </a>
    {% endif %}
</div>
{% endif %}

{% endblock %}