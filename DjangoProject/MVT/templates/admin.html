<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>P√¥le Administratif - Benjamin Immobilier</title>
	
	<!-- Google Font Link for Icons -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
	
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		
		body {
			font-family: Arial, sans-serif;
			background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
			min-height: 100vh;
			padding: 20px;
		}
		
		.main-header {
			background: #1a2f5a;
			padding: 20px 40px;
			margin: -20px -20px 30px -20px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.2);
		}
		
		.logo {
			color: white;
			font-size: 1.8rem;
			font-weight: bold;
			letter-spacing: 2px;
		}
		
		.logo span {
			font-size: 0.9rem;
			font-weight: normal;
			display: block;
			margin-top: 5px;
			letter-spacing: 4px;
		}
		
		.content-wrapper {
			max-width: 1400px;
			margin: 0 auto;
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 30px;
			padding: 20px;
		}
		
		.card {
			background: #f0f0f0;
			border-radius: 1.2em;
			padding: 30px;
			box-shadow: 0 4px 15px rgba(0,0,0,0.15);
		}
		
		.card h2 {
			color: #1e3c72;
			font-size: 1.8rem;
			margin-bottom: 25px;
			font-weight: 600;
		}
		
		@media (max-width: 1024px) {
			.content-wrapper {
				grid-template-columns: 1fr;
			}
		}

		.emails-list {
			max-height: 600px;
			overflow-y: auto;
		}

		.email-item {
			background: white;
			padding: 15px;
			margin-bottom: 10px;
			border-radius: 8px;
			border-left: 4px solid #9B59B6;
			transition: transform 0.2s;
		}

		.email-item.email-replied {
			border-left-color: #27ae60;
			opacity: 0.85;
		}

		.email-item:hover {
			transform: translateX(5px);
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
		}

		.email-header {
			display: flex;
			justify-content: space-between;
			align-items: flex-start;
			margin-bottom: 8px;
			gap: 10px;
		}

		.email-header > div {
			display: flex;
			flex-direction: column;
			gap: 5px;
		}

		.email-header strong {
			color: #1e3c72;
			font-size: 1.1rem;
		}

		.status-badge {
			display: inline-block;
			padding: 4px 10px;
			border-radius: 12px;
			font-size: 0.85rem;
			font-weight: 500;
			background: #e8f4f8;
			color: #2c3e50;
		}

		.email-date {
			color: #666;
			font-size: 0.9rem;
		}

		.email-from {
			color: #555;
			font-size: 0.95rem;
			margin-bottom: 8px;
		}

		.email-preview {
			color: #777;
			font-size: 0.9rem;
			font-style: italic;
		}

		.reply-selector {
			margin-bottom: 20px;
			padding-bottom: 20px;
			border-bottom: 2px solid #e0e0e0;
		}

		.reply-selector label {
			display: block;
			margin-bottom: 8px;
			color: #1e3c72;
			font-weight: 600;
		}

		.reply-selector select {
			width: 100%;
			padding: 10px;
			border: 2px solid #ddd;
			border-radius: 6px;
			font-size: 1rem;
			background: white;
			cursor: pointer;
		}

		.reply-selector select:focus {
			outline: none;
			border-color: #9B59B6;
		}

		#reply-form {
			margin: 20px 0;
			padding: 20px;
			background: #f8f9fa;
			border-radius: 8px;
		}

		.reply-info {
			margin-bottom: 15px;
		}

		.reply-info p {
			margin: 5px 0;
			color: #555;
		}

		#reply-message {
			width: 100%;
			min-height: 150px;
			padding: 12px;
			border: 2px solid #ddd;
			border-radius: 6px;
			font-family: Arial, sans-serif;
			font-size: 0.95rem;
			resize: vertical;
			margin-bottom: 15px;
		}

		#reply-message:focus {
			outline: none;
			border-color: #9B59B6;
		}

		.send-btn {
			width: 100%;
			padding: 12px;
			background: #27ae60;
			color: white;
			border: none;
			border-radius: 6px;
			font-size: 1rem;
			font-weight: 600;
			cursor: pointer;
			transition: background 0.3s;
		}

		.send-btn:hover {
			background: #229954;
		}

		.send-btn:active {
			transform: scale(0.98);
		}

		#reply-status {
			margin-top: 15px;
			padding: 12px;
			border-radius: 6px;
			text-align: center;
			font-weight: 500;
		}

		#reply-status.success {
			background: #d4edda;
			color: #155724;
			border: 1px solid #c3e6cb;
		}

		#reply-status.error {
			background: #f8d7da;
			color: #721c24;
			border: 1px solid #f5c6cb;
		}
	</style>
</head>
<body>
	<div class="main-header">
		<div class="logo">
			BENJAMIN
			<span>IMMOBILIER</span>
		</div>
	</div>

	<div class="content-wrapper">
		<div class="card">
			<h2>Calendrier & Suivi</h2>
			{% include 'calendrier.html' %}
		</div>

		<div class="card">
			<h2>Relance automatique</h2>

			<!-- Menu d√©roulant pour s√©lectionner un email -->
			<div class="reply-selector">
				<label for="email-select">R√©pondre √† un email :</label>
				<select id="email-select" onchange="showReplyForm()">
					<option value="">-- S√©lectionner un email --</option>
					{% for email in emails %}
						{% if email.status == 'pending' %}
							<option value="{{ email.id }}"
								data-from="{{ email.from }}"
								data-subject="{{ email.subject|default:'(Sans objet)' }}">
								{{ email.subject|default:"(Sans objet)"|truncatewords:8 }}
							</option>
						{% endif %}
					{% endfor %}
				</select>
			</div>

			<!-- Formulaire de r√©ponse (cach√© par d√©faut) -->
			<div id="reply-form" style="display: none;">
				<div class="reply-info">
					<p><strong>√Ä :</strong> <span id="reply-to"></span></p>
					<p><strong>Sujet :</strong> <span id="reply-subject"></span></p>
				</div>

				<textarea id="reply-message" placeholder="√âcrivez votre message ici..."></textarea>

				<button onclick="sendReply()" class="send-btn">Envoyer üì®</button>

				<div id="reply-status" style="display: none;"></div>
			</div>

			<!-- Liste des emails -->
			{% if emails %}
				<div class="emails-list">
					{% for email in emails %}
						<div class="email-item {% if email.status == 'replied' %}email-replied{% endif %}">
							<div class="email-header">
								<div>
									<span class="status-badge">{{ email.status_emoji }} {{ email.status_text }}</span>
									<strong>{{ email.subject|default:"(Sans objet)" }}</strong>
								</div>
								<span class="email-date">{{ email.date|date:"d/m/Y H:i" }}</span>
							</div>
							<div class="email-from">De: {{ email.from }}</div>
							<div class="email-preview">{{ email.body_text|truncatewords:20 }}</div>
						</div>
					{% endfor %}
				</div>
			{% else %}
				<p style="color: #666; text-align: center; margin-top: 50px;">
					Aucun email pour le moment. Rechargez la page pour synchroniser.
				</p>
			{% endif %}
		</div>
	</div>

	<script>
		function showReplyForm() {
			const select = document.getElementById('email-select');
			const form = document.getElementById('reply-form');
			const status = document.getElementById('reply-status');

			if (select.value) {
				const option = select.options[select.selectedIndex];
				const from = option.getAttribute('data-from');
				const subject = option.getAttribute('data-subject');

				document.getElementById('reply-to').textContent = from;
				document.getElementById('reply-subject').textContent = 'Re: ' + subject;
				document.getElementById('reply-message').value = '';

				form.style.display = 'block';
				status.style.display = 'none';
			} else {
				form.style.display = 'none';
			}
		}

		function sendReply() {
			const select = document.getElementById('email-select');
			const message = document.getElementById('reply-message').value.trim();
			const status = document.getElementById('reply-status');
			const btn = document.querySelector('.send-btn');

			if (!message) {
				alert('Veuillez √©crire un message');
				return;
			}

			// D√©sactive le bouton pendant l'envoi
			btn.disabled = true;
			btn.textContent = 'Envoi en cours...';

			// R√©cup√®re le token CSRF
			const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');

			fetch('/api/send-reply/', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRFToken': csrftoken
				},
				body: JSON.stringify({
					email_id: select.value,
					message: message
				})
			})
			.then(response => response.json())
			.then(data => {
				status.style.display = 'block';

				if (data.success) {
					status.className = 'success';
					status.textContent = '‚úÖ ' + data.message;

					// R√©initialise le formulaire apr√®s 2 secondes
					setTimeout(() => {
						location.reload();
					}, 2000);
				} else {
					status.className = 'error';
					status.textContent = '‚ùå ' + data.message;
					btn.disabled = false;
					btn.textContent = 'Envoyer üì®';
				}
			})
			.catch(error => {
				status.style.display = 'block';
				status.className = 'error';
				status.textContent = '‚ùå Erreur r√©seau: ' + error;
				btn.disabled = false;
				btn.textContent = 'Envoyer üì®';
			});
		}

		// Fonction pour r√©cup√©rer le cookie CSRF
		function getCookie(name) {
			let cookieValue = null;
			if (document.cookie && document.cookie !== '') {
				const cookies = document.cookie.split(';');
				for (let i = 0; i < cookies.length; i++) {
					const cookie = cookies[i].trim();
					if (cookie.substring(0, name.length + 1) === (name + '=')) {
						cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
						break;
					}
				}
			}
			return cookieValue;
		}
	</script>
</body>
</html>