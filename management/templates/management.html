{% extends 'base.html' %}
{% load static %}

{% block title %}Tableau de bord - Benjamin Immobilier{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static '/css/management.css' %}?v=5" />
<link rel="stylesheet"
   href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
{% endblock %}

{% block content %}

<!-- Statut de synchronisation OAuth -->
<div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-title">
        <span><i class="bi bi-envelope-check"></i> Synchronisation boite mail</span>
    </div>

    <div id="oauth-status-container">
        <div style="text-align: center; padding: 1rem; color: var(--text-secondary);">
            <i class="bi bi-hourglass-split"></i> Chargement du statut...
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 1.5rem;">

   <!-- Card Calendrier -->
   <div class="card" style="height: 100%;">
      <div class="card-title">Calendrier & Suivi</div>

      <!-- Filtres du calendrier -->
      <div class="calendar-filters">
         <!-- Les filtres seront generes dynamiquement par JavaScript -->
      </div>

      <!-- Calendrier -->
      {% include 'calendar.html' %}
   </div>

   <!-- Card Relance automatique -->
   <div class="card" style="height: 100%; display: flex; flex-direction: column;">
      <div class="card-title">Relance automatique</div>

      <!-- Menu deroulant pour selectionner un email -->
      <div class="reply-selector" style="margin-bottom: 1rem;">
         <label for="email-select" class="form-label">Repondre a un email :</label>
         <select id="email-select" onchange="showReplyForm()" class="form-control">
            <option value="">-- Selectionner un email --</option>
            {% for email in emails %}
            {% if email.status == 'pending' %}
            <option value="{{ email.id }}" data-to="{{ email.to }}"
               data-subject="{{ email.subject|default:'(Sans objet)' }}">
               {{ email.subject|default:"(Sans objet)"|truncatewords:8 }}
            </option>
            {% endif %}
            {% endfor %}
         </select>
      </div>

      <!-- Formulaire de reponse (cache par defaut) -->
      <div id="reply-form"
         style="display: none; background: #f8fafc; border-radius: var(--radius-md); padding: 1rem; margin-bottom: 1rem; border: 1px solid var(--border-light);">
         <div class="reply-info" style="margin-bottom: 1rem; font-size: 0.9rem;">
            <p><strong>A :</strong> <span id="reply-to"></span></p>
            <p><strong>Sujet :</strong> <span id="reply-subject"></span></p>
         </div>

         <!-- Bouton Auto-generer -->
         <button onclick="autoGenerate()" class="btn btn-primary auto-btn" type="button"
            style="width: 100%; margin-bottom: 1rem;">
            <i class="bi bi-robot"></i> Auto-generer le message
         </button>

         <textarea id="reply-message" class="form-control" style="min-height: 150px; margin-bottom: 1rem;"
            placeholder="Ecrivez votre message ici..."></textarea>

         <button onclick="sendReply()" class="btn btn-success send-btn" style="width: 100%; justify-content: center;">Envoyer
            ðŸ“¨</button>

         <div id="reply-status" style="display: none; margin-top: 1rem;"></div>
      </div>

      <!-- Liste des emails -->
      {% if emails %}
      <div class="emails-list" style="flex: 1; overflow-y: auto; padding-right: 5px;">
         {% for email in emails %}
         <div class="email-item {% if email.status == 'replied' %}email-replied{% endif %}"
            style="border: 1px solid #e2e8f0; border-left-width: 4px;">
            <div class="email-header">
               <div>
                  <span class="status-badge" style="background: #e2e8f0;"
                  >{{ email.status_emoji }} {{ email.status_text }}</span>
                  <strong style="display: block; margin-top: 4px;">{{ email.subject|default:"(Sans objet)" }}</strong>
               </div>
               <span class="email-date" style="font-size: 0.8rem;">{{ email.date|date:"d/m/Y H:i" }}</span>
            </div>
            <div class="email-from">A: {{ email.to }}</div>
            <div class="email-preview">{{ email.body_text|truncatewords:20 }}</div>
         </div>
         {% endfor %}
      </div>
      {% else %}
      <p style="color: var(--text-secondary); text-align: center; margin-top: 2rem;">
         Aucun email pour le moment.
      </p>
      {% endif %}
   </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static '/js/mails.js' %}?v=6"></script>
<script src="{% static '/js/calendar.js' %}?v=4"></script>
<script src="{% static '/js/oauth_status.js' %}?v=6"></script>
{% endblock %}