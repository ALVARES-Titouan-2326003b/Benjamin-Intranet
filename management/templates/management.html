{% extends 'base.html' %}
{% load static %}

{% block title %}Tableau de bord - Benjamin Immobilier{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static '/css/management.css' %}?v=5" />
<link rel="stylesheet"
   href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
{% endblock %}

{% block content %}

<!-- Statut de synchronisation OAuth -->
<div class="card" style="margin-bottom: 1.5rem;">
   <div class="card-title">
      <span><i class="bi bi-envelope-check"></i> Synchronisation bo√Æte mail</span>
   </div>

   <div id="oauth-status-container">
      <div style="text-align: center; padding: 1rem; color: var(--text-secondary);">
         <i class="bi bi-hourglass-split"></i> Chargement du statut...
      </div>
   </div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 1.5rem;">

   <!-- Card Calendrier -->
   <div class="card" style="height: 100%;">
      <div class="card-title">Calendrier & Suivi</div>

      <!-- Filtres du calendrier -->
      <div class="calendar-filters">
         <!-- Les filtres seront g√©n√©r√©s dynamiquement par JavaScript -->
      </div>
      <!-- Bouton pour ajouter une activit√© -->
      <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
         <button id="add-activity-btn" class="btn btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="bi bi-plus-circle"></i> Ajouter une activit√©
         </button>
      </div>

      <!-- Calendrier -->
      {% include 'calendar.html' %}
   </div>

   <!-- Card Relance automatique -->
   <div class="card" style="height: 100%; display: flex; flex-direction: column;">
      <div class="card-title">Relance automatique</div>

      <!-- Menu d√©roulant pour s√©lectionner un email -->
      <div class="reply-selector" style="margin-bottom: 1rem;">
         <label for="email-select" class="form-label">R√©pondre √† un email :</label>
         <select id="email-select" onchange="showReplyForm()" class="form-control">
            <option value="">-- S√©lectionner un email --</option>
            {% for email in emails %}
            {% if email.status == 'pending' %}
            <option value="{{ email.id }}" data-to="{{ email.to }}"
               data-subject="{{ email.subject|default:'(Sans objet)' }}">
               {{ email.subject|default:"(Sans objet)"|truncatewords:8 }}
            </option>
            {% endif %}
            {% endfor %}
         </select>
      </div>

      <!-- Formulaire de r√©ponse (cach√© par d√©faut) -->
      <div id="reply-form"
         style="display: none; background: #f8fafc; border-radius: var(--radius-md); padding: 1rem; margin-bottom: 1rem; border: 1px solid var(--border-light);">
         <div class="reply-info" style="margin-bottom: 1rem; font-size: 0.9rem;">
            <p><strong>√Ä :</strong> <span id="reply-to"></span></p>
            <p><strong>Sujet :</strong> <span id="reply-subject"></span></p>
         </div>

         <!-- Bouton Auto-g√©n√©rer -->
         <button onclick="autoGenerate()" class="btn btn-primary auto-btn" type="button"
            style="width: 100%; margin-bottom: 1rem;">
            <i class="bi bi-robot"></i> Auto-g√©n√©rer le message
         </button>

         <textarea id="reply-message" class="form-control" style="min-height: 150px; margin-bottom: 1rem;"
            placeholder="√âcrivez votre message ici..."></textarea>

         <button onclick="sendReply()" class="btn btn-success send-btn"
            style="width: 100%; justify-content: center;">Envoyer
            üì®</button>

         <div id="reply-status" style="display: none; margin-top: 1rem;"></div>
      </div>

      <!-- Liste des emails -->
      {% if emails %}
      <div class="emails-list" style="flex: 1; overflow-y: auto; padding-right: 5px;">
         {% for email in emails %}
         <div class="email-item {% if email.status == 'replied' %}email-replied{% endif %}"
            style="border: 1px solid #e2e8f0; border-left-width: 4px;">
            <div class="email-header">
               <div>
                  <span class="status-badge" style="background: #e2e8f0;"
                  >{{ email.status_emoji }} {{ email.status_text }}</span>
                  <strong style="display: block; margin-top: 4px;">{{ email.subject|default:"(Sans objet)" }}</strong>
               </div>
               <span class="email-date" style="font-size: 0.8rem;">{{ email.date|date:"d/m/Y H:i" }}</span>
            </div>
            <div class="email-from">A: {{ email.to }}</div>
            <!-- "to" because it's sent to us? or from? Check context. Original code said "A: {{ email.to }}" but variable is email.to. Assuming original logic. -->
            <div class="email-preview">{{ email.body_text|truncatewords:20 }}</div>
         </div>
         {% endfor %}
      </div>
      {% else %}
      <p style="color: var(--text-secondary); text-align: center; margin-top: 2rem;">
         Aucun email pour le moment.
      </p>
      {% endif %}
   </div>
</div>

<!-- Modal pour ajouter une activit√© -->
<div id="activity-modal" class="activity-modal" style="display: none;">
   <div class="activity-modal-content">
      <div class="activity-modal-header">
         <h3><i class="bi bi-calendar-plus"></i> Nouvelle activit√©</h3>
         <button id="close-modal-btn" class="activity-modal-close">&times;</button>
      </div>

      <form id="activity-form" class="activity-form">
         {% csrf_token %}

         <div class="form-group">
            <label for="activity-dossier" class="form-label">Dossier *</label>
            <select id="activity-dossier" name="dossier" class="form-control" required>
               <option value="">-- S√©lectionner un dossier --</option>
               {% for dossier in dossiers %}
               <option value="{{ dossier.reference }}">{{ dossier.reference }}</option>
               {% endfor %}
            </select>
         </div>

         <div class="form-group">
            <label for="activity-type" class="form-label">Type *</label>
            <select id="activity-type" name="type" class="form-control" required>
               <option value="">-- S√©lectionner un type --</option>
               {% for type in types %}
               <option value="{{ type.type }}">{{ type.type }}</option>
               {% endfor %}
            </select>
         </div>

         <div class="form-group">
            <label for="activity-date" class="form-label">Date *</label>
            <input type="datetime-local" id="activity-date" name="date" class="form-control" required>
         </div>

         <div class="form-group">
            <label for="activity-commentaire" class="form-label">Commentaire</label>
            <textarea id="activity-commentaire" name="commentaire" class="form-control" rows="3"
               placeholder="D√©tails optionnels..."></textarea>
         </div>

         <div id="activity-form-status" style="display: none; margin-top: 1rem; padding: 0.75rem; border-radius: 6px;">
         </div>

         <div style="display: flex; gap: 0.75rem; justify-content: space-between; margin-top: 1.5rem;">
            <button type="button" id="delete-activity-btn" class="btn btn-danger" style="flex: 1;">
               <i class="bi bi-trash"></i> Supprimer
            </button>
            <div style="display: flex; gap: 0.75rem; flex: 1;">
               <button type="button" id="cancel-activity-btn" class="btn btn-secondary"
                  style="flex: 1;">Annuler</button>
               <button type="submit" class="btn btn-success" style="flex: 1;">
                  <i class="bi bi-check-circle"></i> Enregistrer
               </button>
            </div>
         </div>
      </form>
   </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static '/js/mails.js' %}?v=4"></script>
<script src="{% static '/js/calendar.js' %}?v=4"></script>
<script src="{% static '/js/oauth_status.js' %}?v=4"></script>
{% endblock %}