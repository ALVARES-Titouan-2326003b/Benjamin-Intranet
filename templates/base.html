{% load static %}
<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Benjamin Immobilier{% endblock %}</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="{% static 'img/favicon.png' %}">
  <link rel="shortcut icon" href="{% static 'img/favicon.png' %}">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <link rel="stylesheet" href="{% static 'css/main.css' %}">

  {% block extra_css %}{% endblock %}
</head>

<body>

  {% if user.is_authenticated %}
  <aside class="app-sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        Benjamin
        <span>Immobilier</span>
      </div>
    </div>

    <nav class="sidebar-nav">

      <a href="{% url 'home' %}" class="nav-item {% if request.path == '/' %}active{% endif %}">
        <i class="bi bi-grid-1x2"></i> Tableau de bord
      </a>

      {# Utilisation de 'with' pour simplifier et raccourcir les lignes #}
      {# u_groups_str convertit la liste des groupes en chaîne pour la recherche #}
      {% with p=request.path u_groups_str=request.user.groups.all|escape %}

      {% if '/finance/' in p or '/signatures/' in p or '/gestion-des-candidatures/' in p %}
      <div class="nav-section-label">FINANCE & RH</div>

      {# --- CORRECTION : Condition séparée pour éviter les erreurs de syntaxe sur les lignes longues --- #}
      {% if user.is_superuser or user.is_staff or "COLLABORATEUR" in u_groups_str or "POLE_FINANCIER" in u_groups_str %}
      <a href="{% url 'invoices:list' %}" class="nav-item {% if '/finance/' in p %}active{% endif %}">
        <i class="bi bi-receipt"></i> Factures
      </a>
      {% endif %}

      {% if user.is_superuser or user.is_staff or "POLE_FINANCIER" in u_groups_str %}
      <a href="{% url 'signatures:document_list' %}" class="nav-item {% if '/signatures/' in p %}active{% endif %}">
        <i class="bi bi-pen"></i> Signatures
      </a>
      <a href="{% url 'recrutement:dashboard' %}"
        class="nav-item {% if '/gestion-des-candidatures/' in p %}active{% endif %}">
        <i class="bi bi-person-badge"></i> Candidatures
      </a>
      {% endif %}
      {% endif %}

      {% if '/pole-technique/' in p or '/chatbot/' in p %}
      <div class="nav-section-label">TECHNIQUE</div>
      {% if user.is_superuser or user.is_staff or "POLE_TECHNIQUE" in u_groups_str %}
      <a href="{% url 'technique_financial_overview' %}"
        class="nav-item {% if '/vue-financiere/' in request.path %}active{% endif %}">
        <i class="bi bi-graph-up"></i> Vue Financière
      </a>

      <a href="{% url 'technique:documents_list' %}"
        class="nav-item {% if '/documents/' in request.path %}active{% endif %}">
        <i class="bi bi-folder"></i> Documents
      </a>
      {% endif %}
      {% endif %}

      {% if '/administratif/' in request.path or '/admin/' in request.path %}
      <div class="nav-section-label">ADMINISTRATIF</div>
      {% if user.is_superuser or user.is_staff or "POLE_ADMINISTRATIF" in u_groups_str %}
      <a href="{% url 'admin_view' %}" class="nav-item {% if '/administratif/' in request.path %}active{% endif %}">
        <i class="bi bi-speedometer2"></i> Vue d'ensemble
      </a>
      {% endif %}
      {% endif %}

      {% endwith %}
    </nav>
  </aside>
  {% endif %}

  <div class="app-main {% if not user.is_authenticated %}auth-mode{% endif %}">

    {% if user.is_authenticated %}
    <header class="app-header">
      {% if user.is_superuser or user.is_staff %}
      <div class="header-search">
        <form action="{% url 'global_search' %}" method="get" style="display: flex; align-items: center; width: 100%;">
          <i class="bi bi-search"></i>
          <input type="text" name="q" placeholder="Rechercher un document, client, facture..."
            value="{{ query|default:'' }}">
        </form>
      </div>
      {% endif %}

      <div class="header-user">
        {% if user.is_authenticated %}
        <div class="user-info">
          <span class="user-name">{{ user.username|title }}</span>
          <span class="user-role">
            {% if user.is_superuser %}
            Administrateur
            {% elif user.groups.exists %}
            {{ user.groups.all|join:", "|title }}
            {% else %}
            Collaborateur
            {% endif %}
          </span>
        </div>
        <div class="user-avatar">
          {{ user.username|first|upper }}
        </div>

        <form action="{% url 'logout' %}" method="post" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm"
            style="background:none; border:none; padding: 5px; color: var(--text-secondary);" title="Déconnexion">
            <i class="bi bi-box-arrow-right" style="font-size: 1.2rem;"></i>
          </button>
        </form>
        {% else %}
        <a href="{% url 'two_factor:login' %}" class="btn btn-primary">Se connecter</a>
        {% endif %}
      </div>
    </header>
    {% endif %}

    <main class="page-content">
      {% if messages %}
      <div class="messages">
        {% for message in messages %}
        <div class="alert {{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>
      {% endif %}

      {% block content %}{% endblock %}
    </main>

  </div>

  {# Chatbot visible uniquement pour superusers et staff (pas les simples collaborateurs) #}
  {% if user.is_authenticated %}
  {% if user.is_superuser or user.is_staff %}
  {% include 'chatbot/widget.html' %}
  {% endif %}
  {% endif %}
  {% block extra_js %}{% endblock %}
</body>

</html>