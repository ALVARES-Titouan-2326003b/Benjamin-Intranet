{% extends "base_signatures.html" %}

{% block title %}Placer la signature – {{ doc.titre }}{% endblock %}
{% block header_title %}Placer la signature sur le document{% endblock %}

{% block content %}
<div class="sig-card">
    <h2 class="sig-card-title">{{ doc.titre }}</h2>
    <p>
        {% if is_ceo %}
            Déplace le bloc “Tampon + Signature” à l’endroit souhaité, puis signe le document.
        {% else %}
            Déplace le bloc “Tampon + Signature” à l’endroit souhaité, puis envoie une
            demande de signature au CEO.
        {% endif %}
    </p>

    <div class="sig-pdf-wrapper">
        <div id="page">
            <embed
                id="pdf-preview"
                src="{{ doc.fichier.url }}#page=1&zoom=page-width&toolbar=0&navpanes=0"
                type="application/pdf"
            >

            <div id="sig-block">
                Tampon + Signature
            </div>
        </div>
    </div>

    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="pos_x_pct" id="pos_x_pct">
        <input type="hidden" name="pos_y_pct" id="pos_y_pct">
        <button type="submit" class="sig-btn sig-btn-primary">
            {% if is_ceo %}
                Signer à cet endroit
            {% else %}
                Demander la signature à cet endroit
            {% endif %}
        </button>
    </form>

    <p style="margin-top: 10px;">
        <a href="{{ doc.fichier.url }}" target="_blank">Ouvrir le PDF dans un nouvel onglet</a> ·
        <a href="{% url 'signatures:document_detail' doc.pk %}">Annuler</a>
    </p>
</div>

<script>
    (function() {
        const page = document.getElementById("page");
        const block = document.getElementById("sig-block");
        const inputX = document.getElementById("pos_x_pct");
        const inputY = document.getElementById("pos_y_pct");

        let offsetX = 0;
        let offsetY = 0;
        let dragging = false;

        function initPosition() {
            const pageRect = page.getBoundingClientRect();
            const blockRect = block.getBoundingClientRect();

            const left = (pageRect.width - blockRect.width) / 2;
            const top = pageRect.height - blockRect.height - 40;

            block.style.left = left + "px";
            block.style.top = top + "px";
            updateHiddenInputs();
        }

        function updateHiddenInputs() {
            const pageRect = page.getBoundingClientRect();
            const blockRect = block.getBoundingClientRect();

            const leftPx = blockRect.left - pageRect.left;
            const topPx = blockRect.top - pageRect.top;
            const blockHeight = blockRect.height;

            const xPct = (leftPx / pageRect.width) * 100;
            const bottomPx = pageRect.height - (topPx + blockHeight);
            const yPct = (bottomPx / pageRect.height) * 100;

            inputX.value = xPct.toFixed(2);
            inputY.value = yPct.toFixed(2);
        }

        block.addEventListener("mousedown", function(e) {
            dragging = true;
            const blockRect = block.getBoundingClientRect();
            offsetX = e.clientX - blockRect.left;
            offsetY = e.clientY - blockRect.top;
        });

        document.addEventListener("mousemove", function(e) {
            if (!dragging) return;

            const pageRect = page.getBoundingClientRect();
            let newLeft = e.clientX - pageRect.left - offsetX;
            let newTop = e.clientY - pageRect.top - offsetY;

            const maxLeft = pageRect.width - block.offsetWidth;
            const maxTop = pageRect.height - block.offsetHeight;

            if (newLeft < 0) newLeft = 0;
            if (newTop < 0) newTop = 0;
            if (newLeft > maxLeft) newLeft = maxLeft;
            if (newTop > maxTop) newTop = maxTop;

            block.style.left = newLeft + "px";
            block.style.top = newTop + "px";

            updateHiddenInputs();
        });

        document.addEventListener("mouseup", function() {
            dragging = false;
        });

        initPosition();
    })();
</script>
{% endblock %}
