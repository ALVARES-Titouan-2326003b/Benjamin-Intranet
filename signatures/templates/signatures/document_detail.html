{% extends "base.html" %}

{% block title %}{{ doc.titre }}{% endblock %}

{% block content %}
<div class="d-flex justify-between align-center mb-4" style="margin-bottom: 1.5rem;">
    <div>
        <a href="{% url 'signatures:document_list' %}"
            style="text-decoration: none; color: var(--text-secondary); font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
            <i class="bi bi-arrow-left"></i> Retour à la liste
        </a>
        <h2>{{ doc.titre }}</h2>
        <div style="font-size: 0.9rem; color: var(--text-secondary);">
            <i class="bi bi-calendar"></i> Ajouté le {{ doc.date_upload|date:"d/m/Y H:i" }}
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; align-items: start;">

    <!-- Left Column: Document & Actions -->
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">

        <div class="card">
            <div class="card-title">Fichiers</div>

            <div style="display: flex; gap: 1rem; align-items: center;">
                <div
                    style="flex: 1; padding: 1rem; background: #f8fafc; border: 1px solid var(--border-light); border-radius: var(--radius-md);">
                    <div style="font-weight: 500; margin-bottom: 0.5rem;">Fichier original</div>
                    <a href="{{ doc.fichier.url }}" target="_blank" class="btn btn-sm btn-ghost"
                        style="color: var(--primary);">
                        <i class="bi bi-eye"></i> Ouvrir
                    </a>
                </div>

                {% if doc.fichier_signe %}
                <div
                    style="flex: 1; padding: 1rem; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: var(--radius-md);">
                    <div style="font-weight: 500; margin-bottom: 0.5rem; color: #166534;">Fichier signé</div>
                    <a href="{{ doc.fichier_signe.url }}" target="_blank" class="btn btn-sm btn-ghost"
                        style="color: #166534;">
                        <i class="bi bi-download"></i> Télécharger
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-title">Actions requises</div>

            {% if is_signed %}
            <div class="alert alert-success">
                <i class="bi bi-check-circle-fill"></i> Ce document a été signé avec succès.
            </div>

            {% elif is_ceo %}
            {% if pending_request %}
            <div class="alert alert-warning">
                <h4 style="font-size: 1rem; margin-bottom: 0.5rem; font-weight: 600;">Demande de signature en attente
                </h4>
                <p style="font-size: 0.9rem; margin-bottom: 1rem;">
                    Demandée par <strong>{{
                        pending_request.requested_by.get_full_name|default:pending_request.requested_by.username
                        }}</strong>
                    le {{ pending_request.created_at|date:"d/m/Y H:i" }}.
                </p>
                <a href="{% url 'signatures:signature_approval' pending_request.token %}" class="btn btn-primary">
                    <i class="bi bi-pen"></i> Ouvrir la demande et signer
                </a>
            </div>
            {% else %}
            <div>
                <p style="margin-bottom: 1rem;">Vous pouvez signer ce document directement sans demande préalable.</p>
                <a href="{% url 'signatures:placer_signature' doc.pk %}" class="btn btn-primary">
                    <i class="bi bi-pen"></i> Signer ce document
                </a>
            </div>
            {% endif %}

            {% else %}
            {% if pending_request %}
            <div class="alert alert-info">
                <i class="bi bi-hourglass-split"></i>
                Une demande de signature est en attente auprès du CEO (créée le {{
                pending_request.created_at|date:"d/m/Y" }}).
                <br>Vous serez notifié une fois la signature effectuée.
            </div>
            {% else %}
            <div>
                <p style="margin-bottom: 1rem;">
                    Vous pouvez préparer le document en plaçant l'emplacement du tampon et de la signature, puis
                    l'envoyer au CEO pour validation.
                </p>
                <a href="{% url 'signatures:placer_signature' doc.pk %}" class="btn btn-primary">
                    <i class="bi bi-send"></i> Demander la signature du CEO
                </a>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>

    <!-- Right Column: Timeline -->
    <div class="card">
        <div class="card-title">Historique</div>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            {% for h in historiques %}
            <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
                <div
                    style="width: 2px; background: var(--border-light); align-self: stretch; position: relative; margin-left: 0.5rem;">
                    <div
                        style="width: 10px; height: 10px; background: var(--primary); border-radius: 50%; position: absolute; left: -4px; top: 4px;">
                    </div>
                </div>
                <div style="padding-bottom: 1rem; width: 100%;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">{{ h.date_action|date:"d/m/Y H:i" }}
                    </div>
                    <div style="font-weight: 500;">{{ h.statut }}</div>
                    {% if h.commentaire %}
                    <div
                        style="font-size: 0.9rem; background: #f8fafc; padding: 0.5rem; border-radius: 4px; margin-top: 0.25rem;">
                        "{{ h.commentaire }}"
                    </div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div style="color: var(--text-secondary); font-size: 0.9rem;">Aucune activité enregistrée.</div>
            {% endfor %}
        </div>
    </div>

</div>
{% endblock %}